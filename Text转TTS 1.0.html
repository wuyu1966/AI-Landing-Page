<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本提取与TTS朗读工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入编码处理库 -->
  <script src="https://cdn.jsdelivr.net/npm/jschardet@3.0.0/dist/jschardet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconv-lite@0.6.3/dist/iconv-lite.min.js"></script>
  
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#8B5CF6',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-custom {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .glass-effect {
        backdrop-filter: blur(10px);
        background-color: rgba(255, 255, 255, 0.7);
      }
      .glass-effect-dark {
        backdrop-filter: blur(10px);
        background-color: rgba(30, 41, 59, 0.7);
      }
    }
  </style>
</head>

<body class="font-inter bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-900 dark:to-blue-950 min-h-screen text-slate-800 dark:text-slate-100 transition-custom">
  <!-- 页面容器 -->
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 头部区域 -->
    <header class="mb-10 text-center">
      <div class="flex justify-center items-center mb-2">
        <i class="fa fa-volume-up text-primary text-3xl mr-3 animate-pulse"></i>
        <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-primary dark:text-blue-400 text-shadow">
          文本提取与TTS朗读工具
        </h1>
      </div>
      <p class="text-slate-600 dark:text-slate-300 text-lg max-w-2xl mx-auto">
        输入文本或上传文件，提取内容并使用浏览器内置TTS进行朗读
      </p>
      
      <!-- 主题切换按钮 -->
      <button id="theme-toggle" class="mt-4 p-2 rounded-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-custom">
        <i class="fa fa-moon-o dark:hidden text-slate-700"></i>
        <i class="fa fa-sun-o hidden dark:block text-yellow-300"></i>
      </button>
    </header>

    <!-- 主要内容区域 -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- 左侧：文本输入与文件上传 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 文本输入区域 -->
        <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 transform hover:shadow-xl transition-custom">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-file-text-o text-primary mr-2"></i>文本输入
          </h2>
          <textarea 
            id="text-input" 
            class="w-full h-48 p-4 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-primary focus:border-transparent transition-custom resize-none"
            placeholder="在此输入要朗读的文本..."></textarea>
          <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
            <span id="char-count">0</span> 字符
          </div>
        </section>
        
        <!-- 文件上传区域 -->
        <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 transform hover:shadow-xl transition-custom">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-upload text-primary mr-2"></i>文件上传
          </h2>
          <div id="file-upload-area" class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center hover:border-primary transition-custom cursor-pointer">
            <i class="fa fa-file-text text-5xl text-slate-400 mb-4"></i>
            <p class="mb-2">拖放文本文件到此处，或</p>
            <label class="inline-block bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg cursor-pointer transition-custom">
              <i class="fa fa-folder-open mr-1"></i>选择文件
              <input type="file" id="file-input" accept=".txt" class="hidden">
            </label>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-3">支持 .txt 格式文件</p>
          </div>
          <div id="file-info" class="mt-4 hidden">
            <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
              <div class="flex items-center">
                <i class="fa fa-file-text-o text-primary mr-2"></i>
                <span id="file-name" class="truncate max-w-[70%]"></span>
              </div>
              <button id="clear-file" class="text-slate-500 hover:text-red-500 transition-custom">
                <i class="fa fa-times"></i>
              </button>
            </div>
            
            <!-- 编码信息和选择器 -->
            <div id="encoding-info" class="text-xs text-slate-500 mt-2">
              检测到编码：<span id="detected-encoding">未知</span>
            </div>
            <div class="mt-3">
              <label class="text-sm">手动指定编码（自动检测失败时使用）：</label>
              <select id="manual-encoding" class="ml-2 p-1 border rounded text-sm bg-slate-50 dark:bg-slate-900">
                <option value="auto">自动检测（默认）</option>
                <option value="utf8">UTF-8</option>
                <option value="gbk">GBK/GB2312</option>
                <option value="utf16le">UTF-16 LE</option>
                <option value="utf16be">UTF-16 BE</option>
              </select>
            </div>
          </div>
        </section>
        
        <!-- 提取的文本预览 -->
        <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 transform hover:shadow-xl transition-custom">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-eye text-primary mr-2"></i>提取的文本预览
          </h2>
          <div id="text-preview" class="w-full min-h-[120px] p-4 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 overflow-auto">
            <p class="text-slate-400 dark:text-slate-500 italic text-center">提取的文本将显示在这里...</p>
          </div>
          <div class="mt-4 flex justify-end">
            <button id="extract-text" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-custom flex items-center">
              <i class="fa fa-magic mr-2"></i>提取文本
            </button>
          </div>
        </section>
      </div>
      
      <!-- 右侧：TTS控制区域 -->
      <div class="space-y-6">
        <!-- TTS控制 -->
        <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-6 transform hover:shadow-xl transition-custom sticky top-4">
          <h2 class="text-xl font-semibold mb-6 flex items-center">
            <i class="fa fa-volume-up text-primary mr-2"></i>TTS朗读控制
          </h2>
          
          <!-- 控制按钮 -->
          <div class="flex justify-center space-x-4 mb-8">
            <button id="play-btn" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 text-white flex items-center justify-center shadow-lg hover:shadow-xl transition-custom disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fa fa-play text-2xl"></i>
            </button>
            <button id="pause-btn" class="w-16 h-16 rounded-full bg-amber-500 hover:bg-amber-600 text-white flex items-center justify-center shadow-lg hover:shadow-xl transition-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i class="fa fa-pause text-2xl"></i>
            </button>
            <button id="stop-btn" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg hover:shadow-xl transition-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i class="fa fa-stop text-2xl"></i>
            </button>
          </div>
          
          <!-- 语音设置 -->
          <div class="space-y-4">
            <div>
              <label for="voice-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">选择语音</label>
              <select id="voice-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-primary focus:border-transparent transition-custom">
                <option value="">加载语音中...</option>
              </select>
            </div>
            
            <div>
              <label for="rate" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">语速: <span id="rate-value">1</span></label>
              <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary">
            </div>
            
            <div>
              <label for="pitch" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">音调: <span id="pitch-value">1</span></label>
              <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary">
            </div>
            
            <div>
              <label for="volume" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">音量: <span id="volume-value">1</span></label>
              <input type="range" id="volume" min="0" max="1" step="0.1" value="1" class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary">
            </div>
          </div>
          
          <!-- 状态信息 -->
          <div id="status-info" class="mt-6 p-3 rounded-lg bg-slate-100 dark:bg-slate-700 text-center text-sm hidden">
            <p id="status-message" class="text-slate-700 dark:text-slate-200"></p>
          </div>
          
          <!-- 浏览器提示 -->
          <div class="mt-6 p-3 rounded-lg bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 text-sm">
            <p class="text-blue-700 dark:text-blue-300 flex items-center">
              <i class="fa fa-info-circle mr-2"></i>
              本工具使用Web Speech API，在Chrome、Edge浏览器中体验最佳
            </p>
          </div>
        </section>
      </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="mt-16 text-center text-slate-500 dark:text-slate-400 text-sm">
      <p>© 2023 文本提取与TTS朗读工具 | 使用Web Speech API技术</p>
    </footer>
  </div>
  
  <!-- 通知组件 -->
  <div id="notification" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-xs hidden z-50 glass-effect dark:glass-effect-dark"></div>

  <script>
    // DOM元素
    const themeToggle = document.getElementById('theme-toggle');
    const textInput = document.getElementById('text-input');
    const charCount = document.getElementById('char-count');
    const fileInput = document.getElementById('file-input');
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const clearFile = document.getElementById('clear-file');
    const textPreview = document.getElementById('text-preview');
    const extractTextBtn = document.getElementById('extract-text');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const voiceSelect = document.getElementById('voice-select');
    const rateInput = document.getElementById('rate');
    const pitchInput = document.getElementById('pitch');
    const volumeInput = document.getElementById('volume');
    const rateValue = document.getElementById('rate-value');
    const pitchValue = document.getElementById('pitch-value');
    const volumeValue = document.getElementById('volume-value');
    const statusInfo = document.getElementById('status-info');
    const statusMessage = document.getElementById('status-message');
    const notification = document.getElementById('notification');
    const detectedEncoding = document.getElementById('detected-encoding');
    const manualEncoding = document.getElementById('manual-encoding');
    
    // 全局变量
    let currentFile = null;
    let speechSynthesis = window.speechSynthesis;
    let utterance = null;
    let voices = [];
    let isPaused = false;
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 检查主题偏好
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      // 加载语音列表
      loadVoices();
      
      // 如果语音合成API准备就绪，再次加载语音
      speechSynthesis.onvoiceschanged = loadVoices;
      
      // 初始化字符计数
      updateCharCount();
    });
    
    // 更新字符计数
    textInput.addEventListener('input', updateCharCount);
    
    function updateCharCount() {
      charCount.textContent = textInput.value.length;
    }
    
    // 加载语音列表
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      
      // 添加默认选项
      const defaultOption = document.createElement('option');
      defaultOption.textContent = '默认语音';
      defaultOption.value = '';
      voiceSelect.appendChild(defaultOption);
      
      // 筛选中文语音优先显示
      const chineseVoices = voices.filter(voice => 
        voice.lang.includes('zh') || voice.name.includes('Chinese')
      );
      const otherVoices = voices.filter(voice => 
        !voice.lang.includes('zh') && !voice.name.includes('Chinese')
      );
      
      // 添加中文语音
      if (chineseVoices.length > 0) {
        const groupOption = document.createElement('optgroup');
        groupOption.label = '中文语音';
        chineseVoices.forEach(voice => {
          const option = document.createElement('option');
          option.textContent = `${voice.name} (${voice.lang})`;
          option.value = voice.name;
          groupOption.appendChild(option);
        });
        voiceSelect.appendChild(groupOption);
      }
      
      // 添加其他语音
      if (otherVoices.length > 0) {
        const groupOption = document.createElement('optgroup');
        groupOption.label = '其他语音';
        otherVoices.forEach(voice => {
          const option = document.createElement('option');
          option.textContent = `${voice.name} (${voice.lang})`;
          option.value = voice.name;
          groupOption.appendChild(option);
        });
        voiceSelect.appendChild(groupOption);
      }
      
      // 如果没有语音可用
      if (voices.length === 0) {
        const option = document.createElement('option');
        option.textContent = '未检测到可用语音';
        option.disabled = true;
        voiceSelect.appendChild(option);
        showNotification('未检测到TTS语音，请检查浏览器设置', 'warning');
      }
    }
    
    // 主题切换
    themeToggle.addEventListener('click', () => {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.theme = 'light';
      } else {
        document.documentElement.classList.add('dark');
        localStorage.theme = 'dark';
      }
    });
    
    // 文件上传处理
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });
    
    // 拖放文件处理
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('border-primary');
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('border-primary');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('border-primary');
      
      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
          handleFile(file);
        } else {
          showNotification('请上传文本文件(.txt)', 'error');
        }
      }
    });
    
    fileUploadArea.addEventListener('click', () => {
      fileInput.click();
    });
    
    // 清除文件
    clearFile.addEventListener('click', () => {
      currentFile = null;
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      showNotification('已清除文件');
    });
    
    // 处理文件
    function handleFile(file) {
      currentFile = file;
      fileName.textContent = file.name;
      fileInfo.classList.remove('hidden');
      
      // 预检测编码并显示
      const reader = new FileReader();
      reader.readAsArrayBuffer(file.slice(0, 1024 * 10)); // 读取前10KB用于预检测
      reader.onload = () => {
        const encoding = detectEncoding(reader.result);
        detectedEncoding.textContent = encoding || "未知";
      };
      
      showNotification(`已选择文件: ${file.name}`);
    }
    
    // 提取文本
    extractTextBtn.addEventListener('click', async () => {
      let text = '';
      
      // 从文本输入提取
      if (textInput.value.trim() !== '') {
        text = textInput.value.trim();
        text = cleanText(text);
      }
      // 从文件提取
      else if (currentFile) {
        try {
          text = await readFileWithEncoding(currentFile);
        } catch (error) {
          showEncodingError(error);
          console.error('读取文件失败:', error);
          return;
        }
      }
      // 没有可提取的文本
      else {
        showNotification('请输入文本或上传文件', 'warning');
        return;
      }
      
      // 显示提取的文本
      textPreview.innerHTML = text.replace(/\n/g, '<br>');
      showNotification('文本提取成功');
      
      // 启用控制按钮
      enableControlButtons();
    });
    
    /**
     * 检测文本编码（优化版）
     * @param {ArrayBuffer} buffer - 文件二进制数据
     * @returns {string} 编码格式（如"utf8"、"gbk"）
     */
    function detectEncoding(buffer) {
      // 1. 用jschardet初步检测
      const detection = jschardet.detect(buffer);
      let encoding = detection.encoding?.toLowerCase() || "utf8";
      
      // 2. 规则校验：修正常见误判
      const confidence = detection.confidence || 0;
      const uint8Buffer = new Uint8Array(buffer);
      
      // 若检测为UTF-8但可信度低，且包含GBK特征字节（0x81-0xFE），则修正为GBK
      if (encoding === "utf8" && confidence < 0.7) {
        for (let i = 0; i < uint8Buffer.length; i++) {
          if (uint8Buffer[i] >= 0x81 && uint8Buffer[i] <= 0xFE) {
            encoding = "gbk";
            break;
          }
        }
      }
      
      // 处理UTF-8 BOM（带BOM的UTF-8会被误判为UTF-16）
      if (uint8Buffer.length >= 3 && 
          uint8Buffer[0] === 0xEF && 
          uint8Buffer[1] === 0xBB && 
          uint8Buffer[2] === 0xBF) {
        encoding = "utf8";
      }
      
      return encoding;
    }
    
    /**
     * 读取文件并转换为UTF-8文本（优化版）
     * @param {File} file - 上传的文件
     * @returns {Promise<string>} 转换后的文本
     */
    function readFileWithEncoding(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        // 以ArrayBuffer读取文件（二进制级处理）
        reader.readAsArrayBuffer(file);
        
        reader.onload = () => {
          try {
            const buffer = reader.result;
            // 优先使用用户手动指定的编码
            const manualEnc = document.getElementById("manual-encoding").value;
            const encoding = manualEnc !== "auto" ? manualEnc : detectEncoding(buffer);
            
            let text = "";
            
            // 处理不同编码
            if (encoding === "utf8") {
              // 移除UTF-8 BOM头（若存在）
              text = new TextDecoder("utf-8").decode(buffer);
              text = text.replace(/^\ufeff/, ""); // 移除BOM
            } 
            // GBK/GB2312编码（中文常见编码）
            else if (["gbk", "gb2312", "gb18030"].includes(encoding)) {
              // 使用iconv-lite转换（比原生TextDecoder更稳定）
              const uint8Buffer = new Uint8Array(buffer);
              text = iconv.decode(uint8Buffer, "gbk");
            } 
            // UTF-16编码（含LE/BE）
            else if (encoding.includes("utf-16")) {
              // 自动检测字节序（LE小端/BE大端）
              const isLittleEndian = encoding.includes("le");
              text = new TextDecoder(`utf-16${isLittleEndian ? "le" : "be"}`).decode(buffer);
              text = text.replace(/^\ufeff/, ""); // 移除BOM
            } 
            // 其他编码（尝试默认UTF-8容错）
            else {
              text = new TextDecoder("utf-8", { fatal: false, ignoreBOM: true }).decode(buffer);
            }
            
            // 清理无效字符
            text = cleanText(text);
            resolve(text);
          } catch (err) {
            reject(new Error(`编码转换失败：${err.message}`));
          }
        };
        
        reader.onerror = () => reject(new Error("文件读取失败"));
      });
    }
    
    /**
     * 清理文本中的无效字符（优化版）
     * 保留：中文、英文、数字、常见标点、换行/空格
     */
    function cleanText(text) {
      return text
        // 移除控制字符（保留换行、回车、空格）
        .replace(/[\x00-\x1F\x7F-\x9F]/g, (char) => {
          if (["\n", "\r", " "].includes(char)) return char;
          return "";
        })
        // 统一换行符
        .replace(/\r\n/g, "\n")
        // 去除连续空白（保留单个空格）
        .replace(/\s+/g, " ")
        .trim();
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      
      // 设置通知样式
      notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-xs z-50 glass-effect dark:glass-effect-dark';
      
      if (type === 'error') {
        notification.classList.add('text-red-600', 'dark:text-red-400', 'border', 'border-red-200', 'dark:border-red-800');
      } else if (type === 'warning') {
        notification.classList.add('text-amber-600', 'dark:text-amber-400', 'border', 'border-amber-200', 'dark:border-amber-800');
      } else {
        notification.classList.add('text-green-600', 'dark:text-green-400', 'border', 'border-green-200', 'dark:border-green-800');
      }
      
      // 显示通知
      notification.classList.remove('hidden', 'translate-y-20', 'opacity-0');
      
      // 3秒后隐藏
      setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => {
          notification.classList.add('hidden');
        }, 300);
      }, 3000);
    }
    
    // 优化的编码错误提示
    function showEncodingError(error) {
      showNotification(
        `编码处理失败：${error.message}\n建议：1. 尝试手动选择编码 2. 保存文件为UTF-8格式再上传`,
        "error"
      );
    }
    
    // 更新语音参数显示
    rateInput.addEventListener('input', () => {
      rateValue.textContent = rateInput.value;
    });
    
    pitchInput.addEventListener('input', () => {
      pitchValue.textContent = pitchInput.value;
    });
    
    volumeInput.addEventListener('input', () => {
      volumeValue.textContent = volumeInput.value;
    });
    
    // 播放语音
    playBtn.addEventListener('click', () => {
      const text = textPreview.innerHTML.replace(/<br>/g, '\n').trim();
      
      if (text === '' || textPreview.querySelector('p.italic')) {
        showNotification('请先提取文本', 'warning');
        return;
      }
      
      // 如果正在暂停状态，继续播放
      if (isPaused && speechSynthesis.paused) {
        speechSynthesis.resume();
        isPaused = false;
        updateStatus('继续朗读');
        updateControlButtons(false, true, true);
        return;
      }
      
      // 停止任何正在进行的语音
      stopSpeech();
      
      // 创建新的语音实例
      utterance = new SpeechSynthesisUtterance(text);
      
      // 设置语音参数
      const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      utterance.rate = parseFloat(rateInput.value);
      utterance.pitch = parseFloat(pitchInput.value);
      utterance.volume = parseFloat(volumeInput.value);
      
      // 事件监听
      utterance.onstart = () => {
        updateStatus('正在朗读...');
        updateControlButtons(false, true, true);
      };
      
      utterance.onend = () => {
        updateStatus('朗读已完成');
        updateControlButtons(true, false, false);
        isPaused = false;
      };
      
      utterance.onerror = (event) => {
        updateStatus(`发生错误: ${event.error}`, 'error');
        updateControlButtons(true, false, false);
      };
      
      // 开始朗读
      speechSynthesis.speak(utterance);
    });
    
    // 暂停语音
    pauseBtn.addEventListener('click', () => {
      if (speechSynthesis.speaking) {
        if (speechSynthesis.paused) {
          // 继续播放
          speechSynthesis.resume();
          updateStatus('继续朗读');
          updateControlButtons(false, true, true);
          isPaused = false;
        } else {
          // 暂停播放
          speechSynthesis.pause();
          updateStatus('已暂停');
          updateControlButtons(true, false, true);
          isPaused = true;
        }
      }
    });
    
    // 停止语音
    stopBtn.addEventListener('click', () => {
      stopSpeech();
      updateStatus('已停止');
      updateControlButtons(true, false, false);
      isPaused = false;
    });
    
    // 停止语音合成
    function stopSpeech() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
    }
    
    // 更新状态信息
    function updateStatus(message, type = 'info') {
      statusMessage.textContent = message;
      
      if (type === 'error') {
        statusMessage.classList.add('text-red-600', 'dark:text-red-400');
      } else {
        statusMessage.classList.remove('text-red-600', 'dark:text-red-400');
      }
      
      statusInfo.classList.remove('hidden');
      
      // 如果是完成状态，3秒后隐藏
      if (message === '朗读已完成' || message === '已停止') {
        setTimeout(() => {
          statusInfo.classList.add('hidden');
        }, 3000);
      }
    }
    
    // 更新控制按钮状态
    function updateControlButtons(playEnabled, pauseEnabled, stopEnabled) {
      playBtn.disabled = !playEnabled;
      pauseBtn.disabled = !pauseEnabled;
      stopBtn.disabled = !stopEnabled;
    }
    
    // 启用控制按钮
    function enableControlButtons() {
      playBtn.disabled = false;
      stopBtn.disabled = false;
    }
    
    // 兼容老旧浏览器的TextDecoder
    if (typeof TextDecoder === "undefined") {
      // 用iconv-lite替代
      window.TextDecoder = class {
        constructor(encoding) {
          this.encoding = encoding;
        }
        decode(buffer) {
          return iconv.decode(new Uint8Array(buffer), this.encoding);
        }
      };
    }
  </script>
</body>
</html>